<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    .jumbotron {
      background-image: url("./img/sm_colormap-oily.png");
      background-size: cover;
    }

    /* class to add margin to e.g. rows */
    .top-buffer { margin-top:20px; }

    /* Sticky footer styles */
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      /* Margin bottom by footer height */
      margin-bottom: 60px;
    }
    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      /* Set the fixed height of the footer here */
      height: 60px;
    }
  </style>

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
  crossorigin="anonymous">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
  crossorigin="anonymous">

  <link rel="shortcut icon" href="./img/favicon.ico">

  <title>Rhapsody</title>
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="index.html">Rhapsody</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#myNavBar"
            aria-controls="myNavBar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="myNavBar">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="sat_mutagen.html">
          <i>In silico</i> saturation mutagenesis </a></li>
        <li class="nav-item"><a class="nav-link" href="batch_query.html">Batch query</a></li>
      </ul>
      <ul class="navbar-nav navbar-right">
        <li class="nav-item"><a class="nav-link" href="#">Tutorials</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Links</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Download</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
      </ul>
      <!-- <form class="form-inline my-2 my-md-0">
        <input class="form-control" type="text" placeholder="Search">
      </form> -->
    </div>
  </nav>

  <div class="jumbotron">
    <div class="container text-center">
      <h2>Results for job #{{jobid}}</h2>
      (will only be available for 48 hours)
    </div>
  </div>

  <br><br>

  <div class="container">
    <div class="row">
      <div class="col-sm text-center ">
        <h4><i>In silico</i> saturation mutagenesis table</h4>
      </div>
    </div>

    <div class="row">
      <div class="col-sm text-center">
        <div class="py-2">
          <!-- legend -->
          <div class="container">
            <img src="./img/sm_legend.png" class="img" alt="legend" usemap="#map_legend"
            style="max-height: 70px; max-width: 100%;" id="legend">

            <map name="map_legend" id="map_legend">
              <area shape="rect" coords="0,0,1230,360" href="#" alt="1"
              data-toggle="tooltip" data-trigger="hover" data-placement="top" title="1">
              <area shape="rect" coords="1230,0,2640,180" href="#" alt="2"
              data-toggle="tooltip" data-trigger="hover" data-placement="top" title="2">
              <area shape="rect" coords="1230,180,2640,360" href="#" alt="3"
              data-toggle="tooltip" data-trigger="hover" data-placement="top" title="3">
            </map>
          </div>

        </div>
        <!-- sat. mutagen. table(s) -->
        {{images}}
      </div>
    </div>

    <br><br><br>

    <div class="row top-buffer">
      <div class="col-sm text-center">
        <h4>Files</h4>
      </div>
    </div>

    <div class="row">
      <div class="col-sm"></div>
      <div class="col-sm-8 py-2">
        <table class="table table-sm text-center">
          <tbody>
            <tr>
              <td><a href="{{jobdir}}/rhapsody-predictions.txt">Rhapsody predictions</a>
                  <a href="{{jobdir}}/rhapsody-predictions-full.txt">(more details)</a>
              </td>
              <td><a href="{{jobdir}}/rhapsody-EVmutation.txt">EVmutation predictions</a>
                  <a href="https://marks.hms.harvard.edu/evmutation/" target='_blank'>
                     <i class="fas fa-external-link-alt"></i></a>
              </td>
              <td><a href="{{jobdir}}/pph2-short.txt">PolyPhen-2 predictions</a>
                     <a href="http://genetics.bwh.harvard.edu/pph2/" target='_blank'>
                        <i class="fas fa-external-link-alt"></i></a>
              </td>
            </tr>
            <tr>
              <td><a href="{{jobdir}}/rhapsody-Uniprot2PDB.txt">PDB mapping</a></td>
              <td><a href="{{jobdir}}/rhapsody-features.txt">computed features</a></td>
              <td><a href="{{jobdir}}/rhapsody-log.txt">log file</a></td>
            </tr>
            <tr class="table-info">
              <td colspan="3"><a href="{{jobdir}}/rhapsody-results.zip">Download all</a></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col-sm"></div>
    </div>
  </div>



  <br><br><br><br><br><br>


  <footer class="footer">
    <div class="container text-center">
      <span class="text-muted"> lponzoni@pitt.edu -
        <a href="https://www.ccbb.pitt.edu/Faculty/bahar/lab.html">Bahar lab</a>
      </span>
    </div>
  </footer>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
          integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
          integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
          crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
          integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
          crossorigin="anonymous"></script>

  <script>
    // function for rescaling image maps according to their final sizes
    // *after* CSS styling
    function rescale_all_maps() {
      // iterate over all images with maps (saved at the beginning)
      for (var imgID in images_dict){
        var mapID       = images_dict[imgID].mapID;
        var area_coords = images_dict[imgID].area_coords;
        var img = document.getElementById(imgID);
        var map = document.getElementById(mapID);

        // compute rescaling factor
        var rescaling = img.naturalWidth/img.width;

        // apply rescaling to all areas in image map
        console.log('Resizing', mapID);
        for (let i=0; i<map.areas.length; ++i) {
          let orig_coords = area_coords[i].split(",");
          let new_coords = "";
          for (let j=0; j < orig_coords.length; ++j) {
            let x = parseFloat(orig_coords[j]) / rescaling;
            new_coords += Math.round(x) + ",";
          }
          map.areas[i].coords = new_coords.slice(0, -1);
          console.log('Area', i, 'resized from', area_coords[i], 'to', new_coords);
        }
      }
    }

    // create and store dictionary with images, maps and area coordinates
    const allImages = document.querySelectorAll("img");
    var images_dict = {};
	  for (let i=0; i<allImages.length; i++) {
      var dict = {};
      let img = allImages[i];
      if (img.hasAttribute("usemap")) {
        let mapID = img.useMap.slice(1);
        let map = document.getElementById(mapID);
        var area_coords = [];
        for (let j=0; j<map.areas.length; ++j) {
          area_coords.push(map.areas[j].coords);
          // console.log(img.id, mapID, j, area_coords[j]);
        }
        dict["mapID"] = mapID;
        dict["area_coords"] = area_coords;
        images_dict[img.id] = dict;
      };
	  }

    // wait until all images are loaded
    $(window).on("load", rescale_all_maps());
    // $(window).on("resize", rescale_all_maps());

  </script>

</body>

</html>
