<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    .jumbotron {
      background-image: url("./img/sm_colormap-oily.png");
      background-size: cover;
    }

    /* class to add margin to e.g. rows */
    .top-buffer { margin-top:20px; }

    /* Sticky footer styles */
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      /* Margin bottom by footer height */
      margin-bottom: 60px;
    }
    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      /* Set the fixed height of the footer here */
      height: 60px;
    }
  </style>

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
  crossorigin="anonymous">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
  crossorigin="anonymous">

  <link rel="shortcut icon" href="./img/favicon.ico">

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
          integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
          integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
          crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
          integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
          crossorigin="anonymous"></script>

  <script>
    var IMG_DICT  = {};
    var AREA_DICT = {};
    // MAP_DATA contains variables defined in \{\{images\}\}, a placeholder
    // replaced by results.php based on image data
    var MAP_DATA  = {};

    // function for creating a dictionary with images, maps and area coordinates
    function initialize_dicts() {
      const allImages = document.querySelectorAll("img");
      for (let i=0; i<allImages.length; i++) {
        var dict = {};
        let img = allImages[i];
        if (img.hasAttribute("usemap")) {
          let mapID = img.useMap.slice(1);
          dict["mapID"] = mapID;
          dict["areas"] = {};
          let map = document.getElementById(mapID);
          for (let j=0; j<map.areas.length; ++j) {
            let area = map.areas[j];
            let coords = area.coords.split(",");
            let xyxy = [];
            for (let k=0; k<4; ++k) {
              xyxy.push(parseFloat(coords[k]));
            }
            let area_id = area.id;
            AREA_DICT[area_id] = {};
            AREA_DICT[area_id]['coords'] = xyxy;
            AREA_DICT[area_id]['x_min'] = Math.min(xyxy[0], xyxy[2]);
            AREA_DICT[area_id]['y_min'] = Math.min(xyxy[1], xyxy[3]);
            dict["areas"][area_id] = AREA_DICT[area_id];
          }
          IMG_DICT[img.id] = dict;
        };
      };
    }

    // function for rescaling image maps according to their current sizes
    // *after* CSS styling and window resizing
    function rescale_all_maps() {
      // iterate over all images with maps (saved at the beginning)
      for (var imgID in IMG_DICT){
        var mapID = IMG_DICT[imgID].mapID;
        var areas = IMG_DICT[imgID].areas;
        var img = document.getElementById(imgID);
        // compute rescaling factor
        var rescaling = img.naturalWidth/img.width;
        // apply rescaling to all areas in image map
        const area_ids = Object.keys(areas);
        for (var area_id in areas) {
          let orig_coords = areas[area_id]['coords'];
          let new_coords = [0,0,0,0];
          for (let j=0; j<4; ++j) {
            new_coords[j] = Math.round(orig_coords[j]/rescaling);
          }
          document.getElementById(area_id).coords = new_coords.join();
          // store info for each area
          AREA_DICT[area_id]['map_id'] = mapID;
          AREA_DICT[area_id]['x_min']  = Math.min(new_coords[0], new_coords[2]);
          AREA_DICT[area_id]['y_min']  = Math.min(new_coords[1], new_coords[3]);
          AREA_DICT[area_id]['widht']  = Math.abs(new_coords[0] -new_coords[2]);
          AREA_DICT[area_id]['height'] = Math.abs(new_coords[1] -new_coords[3]);
          let num_cols = MAP_DATA[area_id]["num_cols"];
          let num_rows = MAP_DATA[area_id]["num_rows"];
          AREA_DICT[area_id]['dx'] = AREA_DICT[area_id]['widht'] / num_cols;
          AREA_DICT[area_id]['dy'] = AREA_DICT[area_id]['height']/ num_rows;
          // console.log('Area', i, 'resized from', orig_coords.join(),
          // 'to', new_coords.join());
        }
      }
    }

    function updateTooltip(e){
      // triggered by "hover" event on map areas
      var area_id = e.target.id;
      var map_id = AREA_DICT[area_id]['map_id'];
      // the target is the area, but the bounding rectangle is the map's
      var map_rect = e.target.getBoundingClientRect();
      // get mouse coordinates wrt area
      var x = e.clientX - map_rect.left - AREA_DICT[area_id]['x_min'];
      var y = e.clientY - map_rect.top  - AREA_DICT[area_id]['y_min'];
      x = Math.floor(x / AREA_DICT[area_id]['dx']);
      y = Math.floor(y / AREA_DICT[area_id]['dy']);
      // update map title that will be displayed in tooltip
      var map = document.getElementById(map_id);
      var msg = MAP_DATA[area_id]["info_msg"][y][x];
      $(map).attr('title', msg);
    }

    function hideTooltip(e){
      var area_id = e.target.id;
      var map_id = AREA_DICT[area_id]['map_id'];
      var map = document.getElementById(map_id);
      $(map).attr('title', "");
    }
  </script>

  <title>Rhapsody</title>
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="index.html">Rhapsody</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#myNavBar"
            aria-controls="myNavBar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="myNavBar">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="sat_mutagen.html">
          <i>In silico</i> saturation mutagenesis </a></li>
        <li class="nav-item"><a class="nav-link" href="batch_query.html">Batch query</a></li>
      </ul>
      <ul class="navbar-nav navbar-right">
        <li class="nav-item"><a class="nav-link" href="#">Tutorials</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Links</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Download</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
      </ul>
      <!-- <form class="form-inline my-2 my-md-0">
        <input class="form-control" type="text" placeholder="Search">
      </form> -->
    </div>
  </nav>

  <div class="jumbotron">
    <div class="container text-center">
      <h2>Results for job #{{jobid}}</h2>
      (will only be available for 48 hours)
    </div>
  </div>

  <br><br>

  <div class="container">
    <div class="row">
      <div class="col-sm text-center ">
        <h4><i>In silico</i> saturation mutagenesis table</h4>
      </div>
    </div>

    <div class="row">
      <div class="col-sm text-center">
        <!-- legend -->
        <div class="py-2">
          <div class="container">
            <img src="./img/sm_legend.png" class="img" alt="legend"
            style="max-height: 70px; max-width: 100%;" id="legend">
          </div>
        </div>
        <!-- sat. mutagen. table(s) -->
        <div class="py-2">
          {{images}}
        </div>
      </div>
    </div>

    <br><br><br>

    <div class="row top-buffer">
      <div class="col-sm text-center">
        <h4>Files</h4>
      </div>
    </div>

    <div class="row">
      <div class="col-sm"></div>
      <div class="col-sm-8 py-2">
        <table class="table table-sm text-center">
          <tbody>
            <tr>
              <td><a href="{{jobdir}}/rhapsody-predictions.txt">Rhapsody predictions</a>
                  <a href="{{jobdir}}/rhapsody-predictions-full.txt">(more details)</a>
              </td>
              <td><a href="{{jobdir}}/rhapsody-EVmutation.txt">EVmutation predictions</a>
                  <a href="https://marks.hms.harvard.edu/evmutation/" target='_blank'>
                     <i class="fas fa-external-link-alt"></i></a>
              </td>
              <td><a href="{{jobdir}}/pph2-short.txt">PolyPhen-2 predictions</a>
                     <a href="http://genetics.bwh.harvard.edu/pph2/" target='_blank'>
                        <i class="fas fa-external-link-alt"></i></a>
              </td>
            </tr>
            <tr>
              <td><a href="{{jobdir}}/rhapsody-Uniprot2PDB.txt">PDB mapping</a></td>
              <td><a href="{{jobdir}}/rhapsody-features.txt">computed features</a></td>
              <td><a href="{{jobdir}}/rhapsody-log.txt">log file</a></td>
            </tr>
            <tr class="table-info">
              <td colspan="3"><a href="{{jobdir}}/rhapsody-results.zip">Download all</a></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col-sm"></div>
    </div>
  </div>



  <br><br><br><br><br><br>


  <footer class="footer">
    <div class="container text-center">
      <span class="text-muted"> lponzoni@pitt.edu -
        <a href="https://www.ccbb.pitt.edu/Faculty/bahar/lab.html">Bahar lab</a>
      </span>
    </div>
  </footer>


  <script>

    // insert here look-up tables with image info
    {{lookup_tables}}

    $( document ).ready(function() {

      // rescale maps once when all images are loaded...
      $(window).on("load", function() {
        initialize_dicts();
        rescale_all_maps();
      });

      // ... and every time the window is resized
      $(window).resize(function() {
        rescale_all_maps();
      });
    });

  </script>

</body>

</html>
